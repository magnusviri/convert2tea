distributable:
  url: https://packages.groonga.org/source/groonga/groonga-{{ version }}.tar.gz
  strip-components: 1

versions:
  github: groonga/groonga
  strip: /^groonga-/

provides:
  - bin/groonga
  - bin/nroonga
  - bin/groonga-httpd

dependencies:
  llvm.org: '*'
  openssl.org: ^1
  pcre.org: '*'
  msgpack.org: ^4
  mecab.github.io: ^0
  mecab.github.io/geneid: '*'

build:
  dependencies:
    tea.xyz/gx/make: '*'
    freedesktop.org/pkg-config: '*'
    groonga/normalizer-mysql:
      type: groonga_plugin
  script: |
    ./configure $ARGS
    make --jobs {{hw.concurrency}}
    make install
  env:
    ARGS:
      - --prefix="{{prefix}}"
      - --with-openssl
      - --with-zlib

test: |
  groonga --version
  groonga -n test.db <<EOS
  TABLE_CREATE TestTable TABLE_HASH_KEY ShortText
  EOS
  nroonga -n test.db -d test <<EOS
  {
    "_key": "hello",
    "value": "world"
  }
  {
    "_key": "groonga",
    "value": "awesome"
  }
  EOS
  groonga -n test.db <<EOS
  SELECT * FROM TestTable MATCH 'groonga';
  EOS
  groonga-normalizer-mysql --version